# Cross Staking 문서

Cross Staking 프로젝트의 완벽한 이해를 위한 종합 문서입니다.

## 📚 문서 구성

### [00-개요.md](./00-개요.md)
**프로젝트 전체 개요**

프로젝트를 처음 접하는 분들을 위한 입문 문서입니다.

**포함 내용:**
- 프로젝트 소개 및 핵심 특징
- 프로젝트 구조 및 주요 컨트랙트
- 핵심 개념 요약
- 주요 사용 흐름
- 보안 및 최적화 개요

**추천 대상:**
- 프로젝트를 처음 접하는 개발자
- 프로젝트 개요를 빠르게 파악하고 싶은 분
- 전체 구조를 이해하고 싶은 분

---

### [01-아키텍처.md](./01-아키텍처.md)
**시스템 아키텍처 상세 설명**

프로젝트의 전체 구조와 설계 패턴을 깊이 있게 다룹니다.

**포함 내용:**
- 전체 아키텍처 개요 및 계층 구조
- 컨트랙트 상속 관계
- 인터페이스, 라이브러리, 베이스 컨트랙트 설명
- 데이터 흐름 다이어그램
- 권한 아키텍처
- 확장 아키텍처 (Hook, Addon)
- 가스 최적화 아키텍처

**추천 대상:**
- 시스템 설계를 이해하고 싶은 개발자
- 아키텍처 패턴을 학습하고 싶은 분
- 확장 및 커스터마이징을 고려하는 분

---

### [02-핵심개념.md](./02-핵심개념.md)
**핵심 개념 심화 학습**

프로젝트의 핵심 메커니즘을 수학적, 알고리즘적으로 설명합니다.

**포함 내용:**
- 포인트 시스템 (계산 공식, 정밀도, 누적 방식)
- 시즌 시스템 (생명주기, 전환 메커니즘)
- 시즌 집계 시스템 (O(1) 최적화 원리)
- 지연 스냅샷 시스템 (가스 최적화)
- 보상 분배 시스템 (비례 분배, 중복 청구 방지)
- Native CROSS와 WCROSS (변환 메커니즘)

**추천 대상:**
- 내부 로직을 깊이 이해하고 싶은 개발자
- 수학적 원리를 학습하고 싶은 분
- 최적화 기법을 배우고 싶은 분
- 스마트 컨트랙트 설계를 학습하는 분

---

### [03-컨트랙트상세.md](./03-컨트랙트상세.md)
**각 컨트랙트 함수별 상세 설명**

모든 컨트랙트의 함수를 하나하나 상세히 설명합니다.

**포함 내용:**
- **StakingProtocol**: 프로젝트 생성, 관리 함수
- **StakingPool**: 스테이킹, 출금, 시즌 관리, 조회 함수
- **RewardPool**: 보상 예치, 분배, 조회 함수
- **StakingRouter**: Native CROSS 스테이킹, 편의 함수
- **WCROSS**: 래핑/언래핑 함수
- **RankingAddon**: Addon 예제

각 함수마다:
- 시그니처
- 파라미터 설명
- 동작 설명
- 사용 예시
- 주의사항

**추천 대상:**
- 컨트랙트를 직접 호출해야 하는 개발자
- 통합 개발을 진행하는 분
- API 레퍼런스가 필요한 분
- 각 함수의 정확한 동작을 알아야 하는 분

---

### [04-워크플로우.md](./04-워크플로우.md)
**실제 사용 시나리오 및 워크플로우**

실제 사용 케이스별로 단계별 가이드를 제공합니다.

**포함 내용:**

**시나리오 1: 프로젝트 생성 및 운영**
- 프로젝트 생성
- 보상 예치
- 진행 상황 모니터링

**시나리오 2: 일반 사용자 스테이킹**
- Native CROSS 스테이킹
- WCROSS 직접 스테이킹
- 정보 확인
- 보상 청구
- 출금

**시나리오 3: 장기 스테이킹 전략**
- 복수 시즌 참여
- 전략적 청구 시점
- 다중 프로젝트 분산

**시나리오 4: 고급 사용 패턴**
- 가스 최적화
- 청구 미리보기
- 여러 토큰 보상 관리
- 시즌 히스토리 분석

**시나리오 5: 프로젝트 관리자 고급 운영**
- 시즌 타이밍 조정
- Addon 연결
- 긴급 풀 종료

**시나리오 6: 스마트 컨트랙트 통합**
- 자동 재스테이킹
- 볼트 컨트랙트
- 조건부 스테이킹

**추가:**
- 가스 비용 가이드
- 가스 최적화 팁

**추천 대상:**
- 실제 사용 방법을 배우고 싶은 개발자
- 프론트엔드 개발자
- 프로젝트 운영자
- 사용자 가이드가 필요한 분

---

### [05-기술구현.md](./05-기술구현.md)
**기술적 구현 디테일**

고급 기술 및 최적화 기법을 상세히 설명합니다.

**포함 내용:**

1. **Code 컨트랙트 패턴**
   - 컨트랙트 크기 제한 해결
   - Factory 패턴 구현

2. **O(1) 시즌 집계 시스템**
   - 문제 분석
   - 수학적 최적화
   - 구현 및 시뮬레이션

3. **지연 스냅샷 시스템**
   - 가스 폭탄 문제
   - Lazy Evaluation 구현
   - 가스 비용 분석

4. **Transient 재진입 방지**
   - EIP-1153 설명
   - 가스 절약 효과

5. **SafeERC20과 토큰 안전성**
   - 비표준 토큰 문제
   - 안전한 전송 구현

6. **Immutable 변수 최적화**
   - Storage vs Immutable
   - 가스 비용 비교

7. **Unchecked 산술 최적화**
   - 오버플로우 체크 비용
   - 안전한 최적화

8. **Hook 패턴과 확장성**
   - Template Method 패턴
   - 확장 예시

9. **Addon 시스템 아키텍처**
   - 인터페이스 설계
   - 안전 호출 메커니즘
   - Allowlist 시스템

10. **가스 최적화 체크리스트**
    - 종합 최적화 가이드

**추천 대상:**
- 고급 Solidity 개발자
- 최적화 기법을 배우고 싶은 분
- 유사 시스템을 설계하는 분
- 기술적 깊이를 추구하는 분

---

## 🎯 학습 경로

### 초보자 경로
```
00-개요.md
    ↓
04-워크플로우.md (시나리오 1, 2)
    ↓
03-컨트랙트상세.md (필요한 부분만)
```

### 중급자 경로
```
00-개요.md
    ↓
01-아키텍처.md
    ↓
02-핵심개념.md
    ↓
04-워크플로우.md
    ↓
03-컨트랙트상세.md
```

### 고급자 경로
```
00-개요.md
    ↓
01-아키텍처.md
    ↓
02-핵심개념.md
    ↓
05-기술구현.md
    ↓
03-컨트랙트상세.md (레퍼런스)
    ↓
04-워크플로우.md (시나리오 4, 5, 6)
```

### 프로젝트 운영자 경로
```
00-개요.md
    ↓
04-워크플로우.md (시나리오 1, 5)
    ↓
03-컨트랙트상세.md (StakingProtocol, RewardPool)
```

### 프론트엔드 개발자 경로
```
00-개요.md
    ↓
04-워크플로우.md (시나리오 2, 3, 4)
    ↓
03-컨트랙트상세.md (StakingRouter)
```

### 스마트 컨트랙트 통합 개발자 경로
```
01-아키텍처.md
    ↓
03-컨트랙트상세.md
    ↓
04-워크플로우.md (시나리오 6)
    ↓
05-기술구현.md (8, 9)
```

---

## 📊 문서 통계

- **총 문서 수**: 6개
- **총 페이지 수**: 약 150페이지 (예상)
- **총 코드 예제**: 100+ 개
- **다이어그램**: 10+ 개

---

## 🔍 빠른 찾기

### 주요 개념
- **포인트**: [02-핵심개념.md](./02-핵심개념.md#1-포인트-시스템-points-system)
- **시즌**: [02-핵심개념.md](./02-핵심개념.md#2-시즌-시스템-season-system)
- **집계**: [02-핵심개념.md](./02-핵심개념.md#3-시즌-집계-시스템-season-aggregation)
- **스냅샷**: [02-핵심개념.md](./02-핵심개념.md#4-지연-스냅샷-시스템-lazy-snapshot)

### 주요 함수
- **stake()**: [03-컨트랙트상세.md](./03-컨트랙트상세.md#stake)
- **withdrawAll()**: [03-컨트랙트상세.md](./03-컨트랙트상세.md#withdrawall)
- **claimSeason()**: [03-컨트랙트상세.md](./03-컨트랙트상세.md#claimseason)
- **createProject()**: [03-컨트랙트상세.md](./03-컨트랙트상세.md#createproject)

### 최적화 기법
- **O(1) 집계**: [05-기술구현.md](./05-기술구현.md#2-o1-시즌-집계-시스템)
- **지연 스냅샷**: [05-기술구현.md](./05-기술구현.md#3-지연-스냅샷-시스템)
- **Transient**: [05-기술구현.md](./05-기술구현.md#4-transient-재진입-방지-eip-1153)
- **Immutable**: [05-기술구현.md](./05-기술구현.md#6-immutable-변수-최적화)

### 사용 시나리오
- **프로젝트 생성**: [04-워크플로우.md](./04-워크플로우.md#시나리오-1-프로젝트-생성-및-운영)
- **스테이킹**: [04-워크플로우.md](./04-워크플로우.md#시나리오-2-일반-사용자-스테이킹)
- **장기 전략**: [04-워크플로우.md](./04-워크플로우.md#시나리오-3-장기-스테이킹-전략)
- **고급 패턴**: [04-워크플로우.md](./04-워크플로우.md#시나리오-4-고급-사용-패턴)

---

## 📝 추가 자료

### 프로젝트 루트 문서
- **README.md**: 프로젝트 소개 및 빠른 시작
- **DEPLOYMENT.md**: 배포 가이드
- **ADDON_GUIDE.md**: Addon 개발 가이드

### 소스 코드
```
src/
├── interfaces/       # 인터페이스 정의
├── libraries/        # 유틸리티 라이브러리
├── base/            # 추상 베이스 컨트랙트
├── addons/          # 확장 애드온
└── *.sol            # 메인 컨트랙트
```

### 테스트 코드
```
test/
├── Staking.t.sol     # 스테이킹 테스트
├── Rewards.t.sol     # 보상 테스트
├── Season.t.sol      # 시즌 테스트
├── Integrated.t.sol  # 통합 테스트
├── Fuzz.t.sol        # Fuzz 테스트
└── ...
```

---

## ❓ FAQ

**Q: 어떤 문서부터 읽어야 하나요?**
A: [00-개요.md](./00-개요.md)부터 시작하세요. 프로젝트 전체를 이해할 수 있습니다.

**Q: 함수 사용법만 빠르게 알고 싶어요.**
A: [03-컨트랙트상세.md](./03-컨트랙트상세.md)에서 필요한 함수를 찾아보세요.

**Q: 가스 최적화가 어떻게 되어 있나요?**
A: [05-기술구현.md](./05-기술구현.md)에 모든 최적화 기법이 설명되어 있습니다.

**Q: 실제 사용 예제가 있나요?**
A: [04-워크플로우.md](./04-워크플로우.md)에 6가지 시나리오가 준비되어 있습니다.

**Q: Addon을 개발하고 싶어요.**
A: 프로젝트 루트의 ADDON_GUIDE.md와 [05-기술구현.md](./05-기술구현.md#9-addon-시스템-아키텍처)를 참고하세요.

---

## 🎯 주요 기능

### 1. unstake 시 포인트 몰수 시스템
- `Season` 구조체에 `forfeitedPoints` 필드 추가
- unstake 시 몰수된 포인트를 시즌 총 포인트에서 차감
- 정확한 보상 비율 계산 보장

### 2. 사전 예치 기능 (Pre-Deposit)
- 첫 시즌 시작 전 보상 토큰 예치 가능
- `preDepositStartBlock` 파라미터로 예치 시점 제어
- 투명성 제고 및 신뢰도 향상

---

## 🆕 주요 개선사항 (2025-10-22)

### ✨ 주요 개선사항

1. **Project별 Admin 역할 추가**
   - `ProjectInfo`에 `admin` 필드 추가
   - 프로젝트 생성 시 admin 지정 가능
   - Pool 설정 함수에 project admin 권한 부여
   - `setProjectAdmin()` 함수로 admin 변경 가능
   - [상세 설명: 03-컨트랙트상세.md](./03-컨트랙트상세.md#projectinfo-구조체)

2. **Season 데이터 구조 명확화**
   - `totalPoints` vs `aggregatedPoints` 명확한 주석 추가
   - 실시간 누적(aggregatedPoints) vs 확정 캐시(totalPoints) 구분
   - [상세 설명: 02-핵심개념.md](./02-핵심개념.md#시즌-구조)

3. **Safe Math 안전성 문서화**
   - Solidity 0.8+ 오버플로우 체크 설명
   - 포인트 계산 안전성 수학적 증명
   - 오버플로우 안전 여유도 분석 (10^35배)
   - [상세 설명: 05-기술구현.md](./05-기술구현.md#11-safe-math-및-오버플로우-안전성)

4. **최적화 메커니즘 문서화**
   - `finalizeUserSeasonsBatch` 최적화 설명
   - 연속 시즌 처리 로직 명확화
   - 완전 지연 평가 시스템 설명

5. **RewardPool 보안 강화**
   - `setRewardPool()` 1회 제한 명시
   - 재설정 불가 이유 및 보안 고려사항 문서화

6. **RankingAddon 완성**
   - 시즌별 랭킹 추적 기능
   - Top 스테이커 조회 기능
   - 14개 테스트 케이스 (100% 통과)

### 🔧 기술적 개선

- 모든 인터페이스 및 구현체 업데이트
- BaseTest 및 모든 테스트 호환성 확보
- StakingRouter projects() 호출 업데이트
- 포인트 계산 안전성 주석 추가

### 📝 문서 업데이트

- `03-컨트랙트상세.md`: ProjectInfo, admin 역할 추가
- `02-핵심개념.md`: Season 구조체 설명 개선
- `05-기술구현.md`: Safe Math 섹션 추가 (11장)
- 모든 예제 코드 최신 시그니처 반영

---

## 📞 문의 및 기여

문서에 대한 피드백이나 개선 제안은 언제든 환영합니다!

**문서 업데이트 일자**: 2025-10-24
**프로젝트 버전**: v1.0
**작성자**: Cross Staking Team

---

## 📖 문서 목차 요약

1. [00-개요.md](./00-개요.md) - 프로젝트 전체 개요
2. [01-아키텍처.md](./01-아키텍처.md) - 시스템 아키텍처
3. [02-핵심개념.md](./02-핵심개념.md) - 핵심 개념 심화
4. [03-컨트랙트상세.md](./03-컨트랙트상세.md) - 함수별 상세 설명
5. [04-워크플로우.md](./04-워크플로우.md) - 사용 시나리오
6. [05-기술구현.md](./05-기술구현.md) - 기술 구현 디테일

**행복한 코딩 되세요! 🚀**

