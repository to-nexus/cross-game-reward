# Cross Staking 프로젝트 개요

## 프로젝트 소개

Cross Staking은 $CROSS 토큰을 기반으로 한 **다중 프로젝트 스테이킹 플랫폼**입니다. 하나의 프로토콜 내에서 여러 프로젝트가 독립적인 스테이킹 풀을 운영할 수 있으며, 각 프로젝트는 시즌 기반의 보상 분배 시스템을 통해 참여자들에게 보상을 제공합니다.

## 핵심 특징

### 1. 멀티 프로젝트 아키텍처
- **Factory 패턴**: StakingProtocol 컨트랙트가 프로젝트별 풀을 생성
- **독립적 운영**: 각 프로젝트는 독립적인 StakingPool과 RewardPool을 보유
- **중앙 관리**: 하나의 프로토콜에서 모든 프로젝트를 통합 관리

### 2. 시즌 기반 보상 시스템
- **시즌 단위**: 정해진 블록 수로 시즌을 구분 (기본: 약 30일)
- **포인트 누적**: 스테이킹 금액 × 시간에 비례하여 포인트 적립
- **비례 분배**: 시즌 종료 후 포인트 비율에 따라 보상 분배

### 3. 가스 최적화
- **O(1) 시즌 집계**: 전체 스테이커를 순회하지 않고 총 포인트 계산
- **지연 스냅샷**: 사용자 시즌 데이터를 필요 시점에만 계산
- **Transient 재진입 방지**: EIP-1153 활용하여 가스 절약

### 4. 확장 가능한 아키텍처
- **Base 컨트랙트**: 공통 로직을 추상화하여 재사용성 향상
- **Hook 패턴**: 스테이킹/출금/시즌 전환 시 확장 포인트 제공
- **Addon 시스템**: 랭킹, 배지 등 부가 기능을 독립 컨트랙트로 구현

### 5. 네이티브 토큰 지원
- **WCROSS**: Native CROSS를 ERC20으로 래핑
- **StakingRouter**: 사용자는 Native CROSS로 직접 스테이킹 가능
- **자동 변환**: 입금 시 자동 wrap, 출금 시 자동 unwrap

## 프로젝트 구조

```
src/
├── interfaces/          # 인터페이스 정의
│   ├── IStakingProtocol.sol
│   ├── IStakingPool.sol
│   ├── IRewardPool.sol
│   └── IStakingAddon.sol
├── libraries/           # 유틸리티 라이브러리
│   ├── PointsLib.sol
│   └── SeasonLib.sol
├── base/               # 추상 베이스 컨트랙트
│   ├── CrossStakingBase.sol
│   ├── StakingPoolBase.sol
│   └── RewardPoolBase.sol
├── addons/             # 확장 애드온
│   └── RankingAddon.sol
├── StakingProtocol.sol  # 프로토콜 팩토리
├── StakingPool.sol      # 스테이킹 풀 구현
├── RewardPool.sol       # 보상 풀 구현
├── StakingRouter.sol    # Native CROSS 라우터
└── WCROSS.sol          # Wrapped CROSS 토큰
```

## 주요 컨트랙트 역할

| 컨트랙트 | 역할 | 핵심 기능 |
|---------|------|---------|
| **StakingProtocol** | 프로젝트 팩토리 | 프로젝트 생성, 중앙 관리 |
| **StakingPool** | 스테이킹 관리 | 토큰 스테이킹, 포인트 계산, 시즌 관리 |
| **RewardPool** | 보상 관리 | 보상 예치, 보상 분배 |
| **StakingRouter** | 사용자 인터페이스 | Native CROSS 스테이킹, 편의 함수 |
| **WCROSS** | 토큰 래퍼 | Native CROSS ↔ ERC20 변환 |
| **RankingAddon** | 부가 기능 예제 | 스테이커 랭킹 집계 |

## 주요 사용 흐름

### 1. 프로젝트 생성
```
관리자 → StakingProtocol.createProject()
    → StakingPool 배포
    → RewardPool 배포
    → 연결 설정
```

### 2. 스테이킹
```
사용자 → StakingRouter.stake() (Native CROSS 전송)
    → WCROSS.deposit() (자동 wrap)
    → StakingPool.stakeFor() (스테이킹 처리)
    → 포인트 누적 시작
```

### 3. 시즌 전환
```
블록 진행 → 시즌 종료 블록 도달
    → 자동 시즌 롤오버 (첫 트랜잭션 시)
    → 이전 시즌 finalize
    → 새 시즌 시작
```

### 4. 보상 청구
```
프로젝트 생성자 → RewardPool.fundSeason() (보상 예치)
사용자 → StakingPool.claimSeason() (보상 청구)
    → RewardPool.payUser() (보상 전송)
    → 포인트 비율에 따라 보상 지급
```

### 5. 출금
```
사용자 → StakingRouter.unstake()
    → StakingPool.withdrawAllFor() (WCROSS 출금)
    → WCROSS.withdraw() (자동 unwrap)
    → Native CROSS 반환
```

## 핵심 개념

### 포인트 (Points)
- **계산 공식**: `포인트 = 스테이킹 금액 × 경과 시간 / 시간 단위`
- **정밀도**: 1e6 (소수점 6자리)
- **시간 단위**: 기본 1시간 (조정 가능)
- **목적**: 스테이킹 기간과 금액을 공정하게 반영

### 시즌 (Season)
- **정의**: 보상 분배의 기본 단위
- **기간**: 블록 수로 정의 (기본: 2,592,000 블록 ≈ 30일)
- **상태**: 활성 → 종료 → Finalized
- **자동 전환**: 시즌 종료 블록 도달 시 자동 롤오버

### 시즌 집계 (Season Aggregation)
- **목적**: O(1) 복잡도로 시즌 총 포인트 계산
- **방식**: `총 스테이킹 금액 × 시간`을 집계
- **업데이트**: 스테이킹/출금 시마다 증분 업데이트
- **최종화**: 시즌 종료 시 최종 집계

### 지연 스냅샷 (Lazy Snapshot)
- **목적**: 가스 효율적인 사용자 데이터 관리
- **방식**: 실제 필요 시점에만 시즌 데이터 계산
- **트리거**: 청구, 스테이킹, 출금 시
- **장점**: 미청구 사용자의 가스 비용 절감

## 보안 및 권한 관리

### 역할 기반 접근 제어 (RBAC)
- **DEFAULT_ADMIN_ROLE**: 최고 관리자 (3일 전환 지연)
- **MANAGER_ROLE**: 프로토콜 운영 관리자
- **REWARD_POOL_ROLE**: RewardPool 컨트랙트 전용
- **ROUTER_ROLE**: Router 컨트랙트 전용

### 재진입 방지
- **Transient Storage**: EIP-1153 기반 가스 효율적 방어
- **nonReentrant**: 모든 외부 호출 함수에 적용

### 입력 검증
- **주소 검증**: 0 주소 차단
- **금액 검증**: 0 금액 차단, 최소 스테이킹 금액 확인
- **범위 검증**: 시즌, 블록 번호 등 유효성 검사

## 가스 최적화 전략

### 1. 집계 기반 계산
- 전체 스테이커 순회 대신 집계된 값 사용
- 시즌 총 포인트를 O(1)로 계산

### 2. 지연 평가
- 사용자 시즌 데이터를 필요 시점에만 계산
- 미청구 사용자의 가스 비용 없음

### 3. 스토리지 최적화
- Immutable 변수 활용
- Transient storage 활용 (재진입 방지)
- Packed storage (구조체 정렬)

### 4. 배치 처리
- 여러 시즌 데이터를 한 번에 처리
- 다중 보상 청구 지원

### 5. Unchecked 산술
- 오버플로우가 불가능한 루프 카운터에 적용

## 확장성 및 업그레이드

### 확장 포인트
1. **Hook 함수**: `_beforeStake`, `_afterStake` 등
2. **Addon 시스템**: `IStakingAddon` 인터페이스
3. **보너스 보상**: `_calculateBonusReward` 오버라이드

### Addon 시스템
- **독립 컨트랙트**: 부가 기능을 별도 컨트랙트로 구현
- **콜백 방식**: 스테이킹/출금/시즌 종료 시 알림
- **안전 호출**: Addon 실패 시에도 메인 로직은 계속 진행
- **승인 시스템**: Allowlist 기반 Addon 연결

## 테스트 및 감사

### 테스트 커버리지
- **단위 테스트**: Staking.t.sol, Rewards.t.sol, Season.t.sol
- **통합 테스트**: Integrated.t.sol
- **Fuzz 테스트**: Fuzz.t.sol
- **고급 시나리오**: Advanced.t.sol, MultiPool.t.sol

### 감사 문서
- **AUDIT.md**: 보안 감사 체크리스트 및 권장사항
- **REFACTORING_SUMMARY.md**: 리팩토링 히스토리
- **TESTS.md**: 테스트 가이드

## 배포 가이드

### 배포 순서
1. WCROSS 배포
2. StakingPoolCode, RewardPoolCode 배포 (Code 컨트랙트)
3. StakingProtocol 배포
4. StakingRouter 배포
5. 권한 설정 및 프로젝트 생성

### 설정 파라미터
- **seasonBlocks**: 시즌 길이 (블록 수)
- **pointsTimeUnit**: 포인트 계산 시간 단위 (초)
- **blockTime**: 블록 생성 시간 (초)
- **poolEndBlock**: 풀 종료 블록 (선택적)

## 다음 문서

- [01-아키텍처.md](./01-아키텍처.md): 시스템 아키텍처 상세 설명
- [02-핵심개념.md](./02-핵심개념.md): 핵심 개념 심화 학습
- [03-컨트랙트상세.md](./03-컨트랙트상세.md): 각 컨트랙트 함수별 상세 설명
- [04-워크플로우.md](./04-워크플로우.md): 주요 사용 시나리오
- [05-기술구현.md](./05-기술구현.md): 기술적 구현 디테일

