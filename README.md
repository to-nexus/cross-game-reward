# Cross-Staking Protocol

ν”„λ΅μ νΈλ³„ $CROSS ν† ν° μ¤ν…μ΄ν‚Ή λ° λ³΄μƒ λ¶„λ°° ν”„λ΅ν† μ½

## κ°μ”

Cross-Staking Protocolμ€ λ‹¤μ¤‘ ν”„λ΅μ νΈλ¥Ό μ§€μ›ν•λ” μ‹μ¦ κΈ°λ° μ¤ν…μ΄ν‚Ή μ‹μ¤ν…μ…λ‹λ‹¤. κ° ν”„λ΅μ νΈλ” λ…λ¦½μ μΈ μ¤ν…μ΄ν‚Ή ν’€μ„ κ°€μ§€λ©°, μ‹μ¦λ³„λ΅ μ‚¬μ©μμ μ°Έμ—¬λ„λ¥Ό ν¬μΈνΈλ΅ μΈ΅μ •ν•μ—¬ λ³΄μƒμ„ λ¶„λ°°ν•©λ‹λ‹¤.

## μ£Όμ” κΈ°λ¥

### 1. λ‹¤μ¤‘ ν”„λ΅μ νΈ μ§€μ›
- Factory ν¨ν„΄μ„ ν†µν• ν”„λ΅μ νΈλ³„ λ…λ¦½μ μΈ StakingPool μƒμ„±
- κ° ν”„λ΅μ νΈλ” μμ²΄ μ‹μ¦ μ¤μΌ€μ¤„ λ° λ³΄μƒ κµ¬μ΅° λ³΄μ 
- Code μ»¨νΈλ™νΈ ν¨ν„΄μΌλ΅ κ°€μ¤λΉ„ μµμ ν™”
- **CREATE2 λ°°ν¬**λ΅ μ£Όμ† μμΈ΅ κ°€λ¥
  - ν”„λ΅μ νΈ μ΄λ¦„κ³Ό IDλ΅ deterministic address μƒμ„±
  - λ°°ν¬ μ „ μ£Όμ† λ―Έλ¦¬ κ³„μ‚° κ°€λ¥

### 2. μ‹μ¦ κΈ°λ° μ‹μ¤ν…
- λΈ”λ΅ κΈ°λ° μ‹μ¦ κ΄€λ¦¬
- Lazy Evaluationμ„ ν†µν• κ°€μ¤λΉ„ μ κ°
- μλ™ μ‹μ¦ μ „ν™ λ° μλ™ μ‹μ¦ μ¬μ‹μ‘ μ§€μ›
- μ‹μ¦λ³„ λ…λ¦½μ μΈ ν¬μΈνΈ κ³„μ‚° λ° λ³΄μƒ λ¶„λ°°

### 3. ν¬μΈνΈ μ‹μ¤ν…
- μ‹κ°„ κ°€μ¤‘ ν¬μΈνΈ λ„μ  (balance Γ— time)
- μ •λ°€λ„: μ†μμ  6μλ¦¬ (POINTS_PRECISION = 1e6)
- Lazy snapshotμ„ ν†µν• ν¨μ¨μ μΈ λ°μ΄ν„° κ΄€λ¦¬
- μ‹¤μ‹κ°„ ν¬μΈνΈ μ΅°ν λ° μμƒ λ³΄μƒ κ³„μ‚°

### 4. μ μ—°ν• μ¤ν…μ΄ν‚Ή
- μµμ† μ¤ν…μ΄ν‚Ή: 1 CROSS
- λ½μ—… κΈ°κ°„ μ—†μ (μμ λ΅μ΄ μ…μ¶κΈ)
- λ¶„ν•  μ¤ν…μ΄ν‚Ή μ§€μ›
- **unstake μ‹ ν¬μΈνΈ λ°μ μ‹μ¤ν…**:
  - ν„μ¬ μ‹μ¦μ λ„μ  ν¬μΈνΈ λ°μ (μ΄μ „ μ‹μ¦ λ³΄μƒμ€ μ μ§€)
  - λ°μλ ν¬μΈνΈλ” μ‹μ¦ μ΄ ν¬μΈνΈμ—μ„ μ°¨κ°λμ–΄ μ •ν™•ν• λ³΄μƒ λΉ„μ¨ μ μ§€
  - `forfeitedPoints` ν•„λ“λ΅ λ°μλ‰ μ¶”μ 

### 5. λ‹¤μ¤‘ ν† ν° λ³΄μƒ
- μ‹μ¦λ³„ λ‹¤μ–‘ν• ERC20 ν† ν° λ³΄μƒ μ§€μ›
- ν”„λ΅μ νΈ ν¬λ¦¬μ—μ΄ν„°κ°€ μμ λ΅­κ² λ³΄μƒ ν† ν° λ° μλ‰ μ„¤μ •
- λΉ„λ΅€ λ¶„λ°° λ°©μ‹ (μ‚¬μ©μ ν¬μΈνΈ / μ΄ ν¬μΈνΈ)
- **μ‚¬μ „ μμΉ κΈ°λ¥**:
  - μ²« μ‹μ¦ μ‹μ‘ μ „ λ³΄μƒ ν† ν° μμΉ κ°€λ¥
  - `preDepositStartBlock` νλΌλ―Έν„°λ΅ μμΉ κ°€λ¥ μ‹μ  μ μ–΄
  - μ‹μ¦ μ‹μ‘ μ „ λ―Έλ¦¬ λ³΄μƒμ„ μ¤€λΉ„ν•μ—¬ ν¬λ…μ„± μ κ³ 

## μ»¨νΈλ™νΈ κµ¬μ΅°

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ StakingProtocol β”‚ β† Factory & Registry
β””β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”
         β”‚ creates
    β”β”€β”€β”€β”€β”΄β”€β”€β”€β”€β”
    β–Ό         β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β” β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚StakingPoolβ”‚β”‚RewardPoolβ”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β” β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
    β–²              β”‚
    β”‚ uses         β”‚ distributes
    β”‚              β–Ό
    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€[Users]
```

### ν•µμ‹¬ μ»¨νΈλ™νΈ

#### 1. StakingProtocol
- **μ—­ν• **: Factory λ° ν”„λ΅μ νΈ λ μ§€μ¤νΈλ¦¬
- **κΈ°λ¥**:
  - ν”„λ΅μ νΈλ³„ StakingPool λ° RewardPool μƒμ„±
  - ν”„λ΅μ νΈ κ΄€λ¦¬ (ν™μ„±ν™”/λΉ„ν™μ„±ν™”)
  - μ „μ—­ μ„¤μ • κ΄€λ¦¬

#### 2. StakingPool
- **μ—­ν• **: ν”„λ΅μ νΈλ³„ μ¤ν…μ΄ν‚Ή λ° ν¬μΈνΈ κ΄€λ¦¬
- **μ£Όμ” κΈ°λ¥**:
  - μ¤ν…μ΄ν‚Ή (stake/unstake)
  - μ‹μ¦ κ΄€λ¦¬ (rollover, finalize)
  - ν¬μΈνΈ κ³„μ‚° λ° μ¤λƒ…μƒ·
  - λ³΄μƒ μ²­κµ¬ (claimSeason)
- **μµμ ν™”**:
  - Lazy evaluationμΌλ΅ κ°€μ¤λΉ„ μ κ°
  - μ μ €λ³„ μ‹μ¦ λ°μ΄ν„° ν†µν•© κ΄€λ¦¬
  - λ¶ν•„μ”ν• staker μν μ κ±°

#### 3. RewardPool
- **μ—­ν• **: μ‹μ¦λ³„ λ³΄μƒ κ΄€λ¦¬ λ° λ¶„λ°°
- **μ£Όμ” κΈ°λ¥**:
  - λ³΄μƒ ν† ν° μμΉ (fundSeason)
  - λ³΄μƒ μ§€κΈ‰ (payUser)
  - λ‚¨μ€ λ³΄μƒ νμ (recoverRemaining)

#### 4. StakingRouter
- **μ—­ν• **: Native CROSS μ§€μ› λ° ν†µν•© μ΅°ν API
- **μ£Όμ” κΈ°λ¥**:
  - Native CROSS β†” WCROSS μλ™ λ³€ν™
  - ν”„λ΅μ νΈλ³„ ν†µν•© μ΅°ν ν•¨μ
  - μ‚¬μ©μ μΉν™”μ μΈ μΈν„°νμ΄μ¤

## μ½”λ“ κµ¬μ΅° λ° κ°€λ…μ„±

### ν•¨μ λ°°μΉ μμ„
λ¨λ“  μ»¨νΈλ™νΈλ” λ‹¤μ μμ„λ΅ ν•¨μκ°€ λ°°μΉλμ–΄ μμµλ‹λ‹¤:

**1μ°¨ μμ„:**
1. **Execute Functions**: μƒνƒλ¥Ό λ³€κ²½ν•λ” ν•¨μλ“¤ (stake, withdraw, rollover, claim λ“±)
2. **View Functions**: μƒνƒλ¥Ό μ΅°νν•λ” ν•¨μλ“¤ (get*, is* λ“±)
3. **Configuration Functions**: μ„¤μ •μ„ λ³€κ²½ν•λ” ν•¨μλ“¤ (set* λ“±)

**2μ°¨ μμ„ (κ° κ·Έλ£Ή λ‚΄):**
1. External
2. Public
3. Internal
4. Private

μ΄λ¬ν• κµ¬μ΅°λ¥Ό ν†µν•΄ μ½”λ“ κ°€λ…μ„±κ³Ό μ μ§€λ³΄μμ„±μ„ ν¬κ² ν–¥μƒμ‹μΌ°μµλ‹λ‹¤.

## μ£Όμ” μ„¤κ³„ μ›μΉ™

### 1. κ°€μ¤ ν¨μ¨μ„±
- **Lazy Evaluation**: ν•„μ”ν• μ‹μ μ—λ§ λ°μ΄ν„° κ³„μ‚°
  - rolloverSeason μ‹ λ¨λ“  staker μν μ κ±°
  - μ μ €λ³„ μ‹μ¦ λ°μ΄ν„°λ” ν•΄λ‹Ή μ μ €μ μ•΅μ… μ‹μ μ— μ¤λƒ…μƒ·
  - totalPointsλ” μ²« claim μ‹μ μ— κ³„μ‚° λ° μΊμ‹±

- **λ°μ΄ν„° κµ¬μ΅° μµμ ν™”**:
  - UserSeasonDataλ΅ μ‹μ¦λ³„ μ μ € μ •λ³΄ ν†µν•©
  - λ¶ν•„μ”ν• μ¤‘λ³µ μ €μ¥ μ κ±°
  - ν¨μ¨μ μΈ mapping ν™μ©

### 2. λ³΄μ•
- **μ¬μ§„μ… λ°©μ§€**: ReentrancyGuardTransient μ‚¬μ©
- **κ¶ν• κ΄€λ¦¬**: AccessControlDefaultAdminRules
  - DEFAULT_ADMIN_ROLE: μµκ³  κ΄€λ¦¬μ
  - MANAGER_ROLE: μ΄μ κ΄€λ¦¬μ
  - REWARD_POOL_ROLE: RewardPool μ „μ©
- **μ•μ „ν• ν† ν° μ „μ†΅**: SafeERC20 μ‚¬μ©

### 3. ν™•μ¥μ„±
- **λ¨λ“ν™”**: κ° μ»¨νΈλ™νΈμ λ…λ¦½μ μΈ μ±…μ„
- **Factory ν¨ν„΄**: μƒλ΅μ΄ ν”„λ΅μ νΈ μ¶”κ°€ μ©μ΄
- **μ μ—°ν• μ‹μ¦ κ΄€λ¦¬**: μλ™/μλ™ μ‹μ‘, μΆ…λ£ λΈ”λ΅ μ„¤μ • κ°€λ¥

### 4. μ‚¬μ©μ κ²½ν—
- **κ°„λ‹¨ν• μΈν„°νμ΄μ¤**: Routerλ¥Ό ν†µν• Native CROSS μ§€μ›
- **ν¬κ΄„μ μΈ μ΅°ν API**: μ‹¤μ‹κ°„ ν¬μΈνΈ, μμƒ λ³΄μƒ λ“±
- **λ…ν™•ν• μ—λ¬ λ©”μ‹μ§€**: μ»¤μ¤ν…€ μ—λ¬ μ‚¬μ©

## μ‹μ¤ν… νλ¦„

### 1. ν”„λ΅μ νΈ μƒμ„±
```solidity
// StakingProtocol.createProject()
uint projectId = protocol.createProject(
    "ProjectName",
    seasonBlocks,         // μ‹μ¦ κΈΈμ΄ (λΈ”λ΅ μ)
    startBlock,           // μ²« μ‹μ¦ μ‹μ‘ λΈ”λ΅
    endBlock,             // ν’€ μΆ…λ£ λΈ”λ΅ (0μ΄λ©΄ λ¬΄ν•)
    projectAdmin,         // ν”„λ΅μ νΈ κ΄€λ¦¬μ μ£Όμ†
    preDepositStartBlock  // μ‚¬μ „ μμΉ μ‹μ‘ λΈ”λ΅ (0μ΄λ©΄ μ¦‰μ‹ κ°€λ¥)
);
```

### 2. μ¤ν…μ΄ν‚Ή
```solidity
// Native CROSS μ¤ν…μ΄ν‚Ή (Router)
router.stake{value: 10 ether}(projectId);

// λλ” ERC20 μ¤ν…μ΄ν‚Ή (μ§μ ‘)
stakingPool.stake(10 ether);
```

### 3. μ‹μ¦ μ§„ν–‰
```
[μ‹μ¦ 1 μ‹μ‘] β†’ [μ‚¬μ©μ μ¤ν…μ΄ν‚Ή] β†’ [ν¬μΈνΈ λ„μ ] β†’ [μ‹μ¦ 1 μΆ…λ£]
                                                           β†“
                                            [rolloverSeason νΈμ¶]
                                                           β†“
[μ‹μ¦ 2 μ‹μ‘] β†’ ...                            [μ‹μ¦ 1 λ°μ΄ν„° finalize]
```

### 4. λ³΄μƒ μ²­κµ¬
```solidity
// ν”„λ΅μ νΈ ν¬λ¦¬μ—μ΄ν„°: λ³΄μƒ μμΉ
protocol.fundProjectSeason(projectId, seasonNum, rewardToken, amount);

// μ‚¬μ©μ: λ³΄μƒ μ²­κµ¬
stakingPool.claimSeason(seasonNum, rewardToken);
```

## ν¬μΈνΈ κ³„μ‚° κ³µμ‹

```
points = (stakeAmount Γ— timeStaked Γ— POINTS_PRECISION) / pointsTimeUnit

where:
- stakeAmount: μ¤ν…μ΄ν‚Ήν• ν† ν° μλ‰
- timeStaked: μ¤ν…μ΄ν‚Ή μ μ§€ μ‹κ°„ (μ΄)
- POINTS_PRECISION: 1e6 (μ •λ°€λ„)
- pointsTimeUnit: κΈ°μ¤€ μ‹κ°„ λ‹¨μ„ (κΈ°λ³Έ: 1 hour)
```

### μμ‹
- μ‚¬μ©μ A: 10 CROSSλ¥Ό μ‹μ¦ μ „μ²΄ (30μΌ) μ¤ν…μ΄ν‚Ή
- μ‚¬μ©μ B: 5 CROSSλ¥Ό μ‹μ¦ μ „μ²΄ (30μΌ) μ¤ν…μ΄ν‚Ή
- ν¬μΈνΈ λΉ„μ¨: A:B = 2:1
- λ³΄μƒ λ°°λ¶„: μ‹μ¦ μ΄ λ³΄μƒμ 2/3λ¥Ό A, 1/3λ¥Ό Bκ°€ μλ Ή

## μµμ ν™” λ‚΄μ—­

### Lazy Evaluation μ μ©
- **Before**: rolloverSeason μ‹ λ¨λ“  staker μν β†’ O(n) κ°€μ¤λΉ„
- **After**: κ° μ μ €μ μ•΅μ… μ‹μ μ— lazy snapshot β†’ λ¶„μ‚°λ κ°€μ¤λΉ„
- **ν¨κ³Ό**: staker μκ°€ λ§μ„μλ΅ rollover κ°€μ¤λΉ„ μ κ° ν¨κ³Ό μ¦κ°€

### λ°μ΄ν„° κµ¬μ΅° ν†µν•©
- **Before**: seasonUserPoints, seasonPositions, seasonUserClaimed (3κ° mapping)
- **After**: UserSeasonData (λ‹¨μΌ struct)
- **ν¨κ³Ό**: μ½”λ“ κ°€λ…μ„± ν–¥μƒ, λ©”λ¨λ¦¬ ν¨μ¨μ„± μ¦κ°€

### μ¤‘λ³µ λ΅μ§ μ κ±°
- `_calculatePoints` ν—¬νΌ ν•¨μλ΅ ν¬μΈνΈ κ³„μ‚° λ΅μ§ ν†µν•©
- `_ensureUserSeasonSnapshot` λ° `_ensureUserAllPreviousSeasons`λ΅ μ¤λƒ…μƒ· λ΅μ§ ν†µν•©

## κΈ°μ  μ¤νƒ

- **Language**: Solidity ^0.8.13
- **Framework**: Foundry
- **Dependencies**:
  - OpenZeppelin Contracts (AccessControl, ReentrancyGuard, SafeERC20)
- **Testing**: Foundry Test (106 tests, 100% pass rate)

## λ³΄μ• κ³ λ ¤μ‚¬ν•­

### 1. μ¬μ§„μ… κ³µκ²© λ°©μ§€
- λ¨λ“  μ™Έλ¶€ νΈμ¶ ν•¨μμ— `nonReentrant` modifier μ μ©
- Checks-Effects-Interactions ν¨ν„΄ μ¤€μ

### 2. κ¶ν• κ΄€λ¦¬
- 3μΌ delayκ°€ μλ” AccessControlDefaultAdminRules μ‚¬μ©
- μ—­ν• λ³„ κ¶ν• λ¶„λ¦¬

### 3. μ¤λ²„ν”λ΅μ°/μ–Έλ”ν”λ΅μ°
- Solidity 0.8+ λ‚΄μ¥ κ²€μ‚¬ ν™μ©
- SafeERC20μΌλ΅ μ•μ „ν• ν† ν° μ „μ†΅

### 4. λ…Όλ¦¬μ  κ²€μ¦
- κ΄‘λ²”μ„ν• ν…μ¤νΈ μ»¤λ²„λ¦¬μ§€
- Fuzz testing ν¬ν•¨
- Edge case ν…μ¤νΈ

## π“ μƒμ„Έ λ¬Έμ„

ν”„λ΅μ νΈλ¥Ό μ™„λ²½ν μ΄ν•΄ν•κΈ° μ„ν• μΆ…ν•© λ¬Έμ„κ°€ μ¤€λΉ„λμ–΄ μμµλ‹λ‹¤:

### [π“– docs/](./docs/)

| λ¬Έμ„ | λ‚΄μ© | μ¶”μ² λ€μƒ |
|-----|------|---------|
| [00-κ°μ”.md](./docs/00-κ°μ”.md) | ν”„λ΅μ νΈ μ „μ²΄ κ°μ” | λ¨λ“  μ‚¬μ©μ |
| [01-μ•„ν‚¤ν…μ².md](./docs/01-μ•„ν‚¤ν…μ².md) | μ‹μ¤ν… μ•„ν‚¤ν…μ² μƒμ„Έ | κ°λ°μ |
| [02-ν•µμ‹¬κ°λ….md](./docs/02-ν•µμ‹¬κ°λ….md) | ν•µμ‹¬ κ°λ… μ‹¬ν™” ν•™μµ | κ°λ°μ |
| [03-μ»¨νΈλ™νΈμƒμ„Έ.md](./docs/03-μ»¨νΈλ™νΈμƒμ„Έ.md) | ν•¨μλ³„ μƒμ„Έ μ„¤λ… | ν†µν•© κ°λ°μ |
| [04-μ›ν¬ν”λ΅μ°.md](./docs/04-μ›ν¬ν”λ΅μ°.md) | μ‹¤μ  μ‚¬μ© μ‹λ‚λ¦¬μ¤ | μ΄μμ, ν”„λ΅ νΈμ—”λ“ |
| [05-κΈ°μ κµ¬ν„.md](./docs/05-κΈ°μ κµ¬ν„.md) | κΈ°μ  κµ¬ν„ λ””ν…μΌ | κ³ κΈ‰ κ°λ°μ |

**ν•™μµ κ²½λ΅:**
- μ²μ μ ‘ν•λ” κ²½μ°: `00-κ°μ”.md` β†’ `04-μ›ν¬ν”λ΅μ°.md`
- κ°λ°μ: `00-κ°μ”.md` β†’ `01-μ•„ν‚¤ν…μ².md` β†’ `02-ν•µμ‹¬κ°λ….md` β†’ `03-μ»¨νΈλ™νΈμƒμ„Έ.md`
- κ³ κΈ‰ κ°λ°μ: μ „μ²΄ λ¬Έμ„ μμ°¨ μ½κΈ° + `05-κΈ°μ κµ¬ν„.md`

μμ„Έν• λ‚΄μ©μ€ [docs/README.md](./docs/README.md)λ¥Ό μ°Έκ³ ν•μ„Έμ”.

## μ£Όμ” κΈ°λ¥ μƒμ„Έ

### ν¬μΈνΈ λ°μ μ‹μ¤ν…
- unstake μ‹ ν„μ¬ μ‹μ¦μ λ„μ  ν¬μΈνΈ λ°μ
- `forfeitedPoints` ν•„λ“λ΅ λ°μλ ν¬μΈνΈ μ¶”μ 
- μ‹μ¦ μ΄ ν¬μΈνΈμ—μ„ μλ™ μ°¨κ°ν•μ—¬ μ •ν™•ν• λ³΄μƒ λΉ„μ¨ μ μ§€

### μ‚¬μ „ μμΉ κΈ°λ¥
- ν”„λ΅μ νΈ μƒμ„± μ‹ `preDepositStartBlock` μ„¤μ • κ°€λ¥
- μ²« μ‹μ¦ μ‹μ‘ μ „ λ³΄μƒ ν† ν° μμΉ ν—μ©
- ν¬λ…μ„± μ κ³  λ° μ‚¬μ©μ μ‹ λΆ°λ„ ν–¥μƒ

## λΌμ΄μ„ μ¤

MIT License
